<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salón Jahzeel - Admin</title>
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <!-- HEADER -->
  <header class="dashboard-headerbar">
    <div class="headerbar-logo">
      <ion-icon name="cut-outline" style="font-size:1.35em;vertical-align:middle;"></ion-icon>
      <span style="vertical-align:middle;">Salón Jahzeel</span>
    </div>
    <a href="login.html" class="logout-btn" id="cerrarSesionBtn" style="margin-left:auto;">
      <ion-icon name="log-out-outline"></ion-icon> Cerrar sesión
    </a>
  </header>

  <!-- MAIN DASHBOARD -->
  <main class="dashboard-main">
    <div>
      <div class="dashboard-header">PÁGINA DEL ADMIN</div>
      <div class="dashboard-subtitle">Aquí podrás gestionar tanto los productos, así como a los estilistas y las reseñas</div>
    </div>

    <!-- PANEL PRODUCTOS -->
    <div id="productos" class="dashboard-card-panel" style="background:transparent;box-shadow:none;padding-bottom:0;">
      <div class="dashboard-panel-row">
        <!-- IZQUIERDA: CREAR PRODUCTO -->
        <div class="dashboard-card-panel dashboard-mini-panel">
          <form class="sign-up" id="formCrearProducto">
            <h3 class="crear-producto-titulo">Crear Producto</h3>
            <div class="container-input">
              <ion-icon name="pricetag-outline"></ion-icon>
              <input type="text" id="nombre" placeholder="Nombre del producto" required>
            </div>
            <div class="container-input">
              <ion-icon name="barcode-outline"></ion-icon>
              <input type="text" id="sku" placeholder="SKU único" required>
            </div>
            <div class="container-input">
              <ion-icon name="business-outline"></ion-icon>
              <input type="text" id="marca" placeholder="Marca" required>
            </div>
            <div class="container-input">
              <ion-icon name="layers-outline"></ion-icon>
              <input type="text" id="categoria" placeholder="Categoría" required>
            </div>
            <div class="container-input">
              <ion-icon name="cube-outline"></ion-icon>
              <input type="number" id="stock" placeholder="Stock" min="0" required>
            </div>
            <div class="container-input">
              <ion-icon name="cash-outline"></ion-icon>
              <input type="number" id="precio" placeholder="Precio" min="0" step="0.01" required>
            </div>
            <div class="container-input activo-checkbox">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <label for="estaactivo">
                <input type="checkbox" id="estaactivo" checked>
                <span>Producto activo</span>
              </label>
            </div>
            <button class="button" type="submit">Crear producto</button>
          </form>
        </div>
        <!-- DERECHA: PRODUCTOS REGISTRADOS -->
        <div class="dashboard-card-panel dashboard-mini-panel productos-registrados-panel">
          <h3>Productos registrados</h3>
          <div id="listaProductos"></div>
        </div>
      </div>
    </div>

    <!-- PANEL ESTILISTAS -->
    <div id="estilistas" class="dashboard-card-panel" style="background:transparent;box-shadow:none;padding-bottom:0;">
      <div class="dashboard-panel-row">
        <!-- IZQUIERDA: CREAR ESTILISTA -->
        <div class="dashboard-card-panel dashboard-mini-panel">
          <form class="sign-up" id="formCrearEstilista">
            <h3>Crear Estilista</h3>
            <div id="errorEstilista"></div>
            <div class="container-input">
              <ion-icon name="person-outline"></ion-icon>
              <input type="text" id="nombreEstilista" placeholder="Nombre del estilista" required>
            </div>
            <div class="container-input">
              <ion-icon name="call-outline"></ion-icon>
              <input type="text" id="telefonoEstilista" placeholder="Teléfono (10 dígitos)" required maxlength="10" pattern="[0-9]{10}">
            </div>
            <div class="container-input activo-checkbox">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <label for="activoEstilista">
                <input type="checkbox" id="activoEstilista" checked>
                <span>Estilista activo</span>
              </label>
            </div>
            <button class="button" type="submit">Crear estilista</button>
          </form>
        </div>
        <!-- DERECHA: ESTILISTAS REGISTRADOS -->
        <div class="dashboard-card-panel dashboard-mini-panel estilistas-registrados-panel">
          <h3>Estilistas registrados</h3>
          <div id="listaEstilistas"></div>
        </div>
      </div>
    </div>
    
    <!-- PANEL RESEÑAS -->
    <div class="dashboard-card-panel" style="background:transparent;box-shadow:none;">
      <div class="dashboard-panel-row">
        <div class="dashboard-card-panel dashboard-mini-panel reseñas-registradas-panel" style="width:100%;">
          <h3>Todas las reseñas</h3>
          <div id="adminListaReseñas"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- SCRIPTS IONICONS -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <script>
    // ----------- FUNCIONES ADMIN -----------

    // Verifica si el usuario es admin y guarda en localStorage
    async function verificaAdmin() {
      const token = localStorage.getItem('token');
      if (token) {
        try {
          const res = await fetch('http://localhost:5000/api/usuarios/data', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.ok) {
            const data = await res.json();
            if ('esAdmin' in data) {
              localStorage.setItem('esAdmin', data.esAdmin ? 'true' : 'false');
            }
          }
        } catch {}
      }
    }
    function esAdmin() {
      return localStorage.getItem('esAdmin') === 'true';
    }

    // Botón cerrar sesión
    document.getElementById('cerrarSesionBtn').addEventListener('click', function(e) {
      localStorage.removeItem('nombreUsuario');
      localStorage.removeItem('token');
      localStorage.removeItem('idUsuario');
      localStorage.removeItem('esAdmin');
    });

    // ----------- PRODUCTOS -----------

    async function cargarProductosAdmin() {
      const token = localStorage.getItem('token');
      const res = await fetch('http://localhost:5000/api/productos/admin', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const productos = await res.json();
      const cont = document.getElementById('listaProductos');
      cont.innerHTML = "";
      if (!productos.length) {
        cont.innerHTML = "<span>No hay productos registrados.</span>";
        return;
      }
      productos.forEach(p => {
        const id = p.id_producto; // ¡Siempre id_producto!
        const activo = p.estaactivo ? 'Activo' : 'Inactivo';
        cont.innerHTML += `
          <div id="producto-${id}" style='background:#eee;padding:10px;border-radius:5px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;'>
            <div>
              <b>${p.nombre}</b> (${p.sku})<br>
              <b>Marca:</b> ${p.marca} &nbsp; | &nbsp; <b>Categoría:</b> ${p.categoria}<br>
              <b>Precio:</b> $${p.precio} &nbsp; | &nbsp; <b>Stock:</b> ${p.stock}<br>
              <b>Estado:</b>
              <span style='color:${p.estaactivo ? "#008000" : "#d12567"};'>${activo}</span>
              <button class="btn-estado-producto"
                onclick="cambiarEstadoProducto('${id}', ${p.estaactivo ? 'false' : 'true'}, ${p.version})"
                title="${p.estaactivo ? 'Inactivar' : 'Activar'}">
                ${p.estaactivo ? 'Cambiar a estado desactivado' : 'Cambiar a estado activado'}
              </button>
            </div>
            <button class="button"
              style="width:32px;height:32px;background:#d12567;padding:0;border-radius:3px;font-size:18px;"
              title="Eliminar"
              onclick="eliminarProducto('${id}')">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>
        `;
      });
    }

    async function eliminarProducto(id) {
      if (!confirm('¿Seguro que deseas eliminar el producto?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`http://localhost:5000/api/productos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (res.ok) {
          alert("Producto eliminado correctamente");
          await cargarProductosAdmin();
        } else {
          alert(data.message || "No se pudo eliminar el producto.");
        }
      } catch (err) {
        alert("Error de conexión al servidor.");
      }
    }

    async function cambiarEstadoProducto(id, nuevoEstado, version) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`http://localhost:5000/api/productos/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ estaactivo: nuevoEstado, version })
        });
        const data = await res.json();
        if (res.ok) {
          alert("Estado de producto actualizado.");
          cargarProductosAdmin();
        } else {
          alert(data.message || "No se pudo actualizar el estado.");
        }
      } catch (err) {
        alert("Error de conexión al servidor.");
      }
    }

    document.getElementById('formCrearProducto').addEventListener('submit', async function(e){
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const sku = document.getElementById('sku').value;
      const marca = document.getElementById('marca').value;
      const categoria = document.getElementById('categoria').value;
      const stock = parseInt(document.getElementById('stock').value, 10);
      const precio = parseFloat(document.getElementById('precio').value);
      const estaactivo = document.getElementById('estaactivo').checked;
      const token = localStorage.getItem('token');

      try {
        const response = await fetch('http://localhost:5000/api/productos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nombre, sku, marca, categoria, precio, stock, estaactivo })
        });
        const data = await response.json();
        if(response.ok){
          alert("¡Producto creado correctamente!");
          e.target.reset();
          cargarProductosAdmin();
        }else{
          alert(data.message || "No se pudo crear el producto.");
        }
      } catch (err) {
        alert("Error de conexión al servidor.");
      }
    });


    // ----------- ESTILISTAS -----------

    async function cargarEstilistasAdmin() {
      const token = localStorage.getItem('token');
      const res = await fetch('http://localhost:5000/api/estilista', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const estilistas = await res.json();
      const cont = document.getElementById('listaEstilistas');
      cont.innerHTML = "";
      if (!estilistas.length) {
        cont.innerHTML = "<span>No hay estilistas registrados.</span>";
        return;
      }
      estilistas.forEach(e => {
        const activo = e.activo ? 'Activo' : 'Inactivo';
        cont.innerHTML += `
          <div style='background:#eee;padding:10px 12px;border-radius:5px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;'>
            <div>
              <b>${e.nombre}</b> <br>
              <b>Teléfono:</b> ${e.telefono} <br>
              <b>Estado:</b>
              <span style='color:${e.activo ? "#008000" : "#d12567"};'>${activo}</span>
              <button class="btn-estado-estilista"
                onclick="cambiarEstadoEstilista('${e._id}', ${e.activo ? 'false' : 'true'})"
                title="${e.activo ? 'Inactivar' : 'Activar'}">
                ${e.activo ? 'Cambiar a estado desactivado' : 'Cambiar a estado activo'}
              </button>
            </div>
            <button class="button" style="width:32px;height:32px;background:#d12567;padding:0;border-radius:3px;font-size:18px;"
              title="Eliminar" onclick="eliminarEstilista('${e._id}')">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>
        `;
      });
    }

    async function eliminarEstilista(id) {
      if (!confirm('¿Seguro que deseas eliminar al estilista?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`http://localhost:5000/api/estilista/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if(res.ok){
          alert("Estilista eliminado correctamente");
          cargarEstilistasAdmin();
        }else{
          alert(data.message || "No se pudo eliminar el estilista.");
        }
      } catch (err) {
        alert("Error de conexión al servidor.");
      }
    }

    async function cambiarEstadoEstilista(id, nuevoEstado) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`http://localhost:5000/api/estilista/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ activo: nuevoEstado })
        });
        const data = await res.json();
        if(res.ok){
          alert("Estado actualizado...");
          cargarEstilistasAdmin();
        }else{
          alert(data.message || "No se pudo actualizar el estado.");
        }
      } catch (err) {
        alert("Error de conexión al servidor.");
      }
    }

    document.getElementById('formCrearEstilista').addEventListener('submit', async function(e){
      e.preventDefault();
      document.getElementById('errorEstilista').textContent = "";
      const nombre = document.getElementById('nombreEstilista').value;
      const telefono = document.getElementById('telefonoEstilista').value.trim();
      const activo = document.getElementById('activoEstilista').checked;
      const token = localStorage.getItem('token');

      try {
        const response = await fetch('http://localhost:5000/api/estilista', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ nombre, telefono, activo })
        });
        const data = await response.json();
        if(response.ok){
          alert("¡Estilista creado correctamente!");
          e.target.reset();
          cargarEstilistasAdmin();
        }else{
          document.getElementById('errorEstilista').textContent =
            data.message || "No se pudo crear el estilista.";
        }
      } catch (err) {
        document.getElementById('errorEstilista').textContent = "Error de conexión al servidor.";
      }
    });

    // ----------- RESEÑAS -----------

    async function cargarReseñasAdmin() {
      const res = await fetch('http://localhost:5000/api/reviews', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const reviews = await res.json();
      const cont = document.getElementById('adminListaReseñas');
      cont.innerHTML = "";
      if (!reviews.length) {
        cont.innerHTML = "<span>No hay reseñas en el sistema.</span>";
        return;
      }
      reviews.reverse().forEach(r => {
        cont.innerHTML += `
          <div class="reseña-card" id="review-admin-${r._id}">
            <b>Usuario:</b> ${r.usuario}<br>
            <b>Puntaje:</b> ${'⭐'.repeat(r.puntaje)}<br>
            <b>Fecha:</b> ${r.createdAt ? (new Date(r.createdAt)).toLocaleDateString() : ''}<br>
            <span>${r.contenido}</span>
            ${esAdmin() ? `<br><button class="btn-eliminar-resena" onclick="eliminarReseñaAdmin('${r._id}')">Eliminar</button>` : ""}
          </div>
        `;
      });
    }

    async function eliminarReseñaAdmin(id) {
      if (!confirm('¿Seguro que deseas eliminar esta reseña?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch('http://localhost:5000/api/reviews/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          cargarReseñasAdmin();
        } else {
          const err = await res.json();
          alert(err.message || "No se pudo eliminar la reseña.");
        }
      } catch {
        alert("Error de conexión al eliminar la reseña.");
      }
    }

    // ----------- CARGA INICIAL -----------
    (async function(){
      await verificaAdmin();
      cargarProductosAdmin();
      cargarEstilistasAdmin();
      cargarReseñasAdmin();
    })();

  </script>
</body>
</html>